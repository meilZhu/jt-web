import * as PLMVisWeb from './plmvisweb.js';

/* Â© 2016 Siemens Product Lifecycle Management Software Inc. */
(function(){var e=1/255;function t(e){var t=e.g,r=e.h;r.materials={};var f=r.materials,a=0,u=r.numMaterials,n=null,s=0,o=0,i=null;for(a=0;a<u;++a){s=t.getUint8(e.byteOffset,true);e.byteOffset+=1;switch(s){case 0:if(f.phong===undefined){f.phong={index:[],diffuse:[],emissive:[],specular:[],shininess:[]}}n=f.phong;n.diffuse.push(t.getUint32(e.byteOffset,true));n.emissive.push(t.getUint32(e.byteOffset+4,true));n.specular.push(t.getUint32(e.byteOffset+8,true));n.shininess.push(t.getFloat32(e.byteOffset+12,true));e.byteOffset+=16;break;case 1:if(f.flat===undefined){f.flat={index:[],diffuse:[]}}n=f.flat;n.diffuse.push(t.getUint32(e.byteOffset,true));e.byteOffset+=4;break;case 3:if(f.line===undefined){f.line={index:[],color:[]}}n=f.line;n.color.push(t.getUint32(e.byteOffset,true));e.byteOffset+=4;break;case 2:if(f.texture===undefined){f.texture={index:[],texB64Data:[]}}n=f.texture;o=t.getUint32(e.byteOffset,true);e.byteOffset+=4;i=new Uint8Array(t.buffer);n.texB64Data.push(i.subarray(e.byteOffset,e.byteOffset+o));e.byteOffset+=o;break;default:throw{name:"BOD material processing error",message:"Unsupported material type: "+s.toString()}}n.index.push(a)}}function r(t,r){var f=t.g,a=t.h.buffers[t.h.buffers.length-1];var u=0,n=a.i,s=0,o=0,i=0,l=0,g=0,p=0,v=null,y=null,b=null,h=null,d=0,c=null,x=null,O=null,B=0,F=null,m=0,U=[0,0,0],w=null,C=null;a.vertexBuffer=[];a.normalBuffer=[];a.indexBuffer=[];a.groupStartBuffer=[];a.groupCountBuffer=[];a.materialIndexBuffer=[];if(r){w=[];C=[];a.xtBodies=w}v=a.vertexBuffer;y=a.normalBuffer;b=a.indexBuffer;h=a.groupStartBuffer;c=a.groupCountBuffer;x=a.materialIndexBuffer;if(a.hasVertexColors){a.vertexColorBuffer=[];F=a.vertexColorBuffer}else if(a.hasTextureUVs){a.uvCoordinatesBuffer=[];O=a.uvCoordinatesBuffer}for(u=0;u<n;++u){var I=null;if(r){I={};I.faceId=f.getInt32(t.byteOffset,true);t.byteOffset+=4;var k=f.getUint16(t.byteOffset,true);t.byteOffset+=2;var M=w[k];if(!M){M={faces:[]};w[k]=M}M.faces.push(I)}g=f.getInt32(t.byteOffset,true);t.byteOffset+=4;x.push(g);o=f.getUint32(t.byteOffset,true);t.byteOffset+=4;if(I){I.start=b.length;I.groupIndex=h.length}h.push(b.length);d=0;for(s=0;s<o;++s){i=f.getUint16(t.byteOffset,true);t.byteOffset+=2;for(l=0;l<i;++l){var D=0;if(a.j){var A=l%8;if(A===0){m=f.getUint8(t.byteOffset,true);t.byteOffset+=1}D=(m&1<<A)===0;if(!D){U[l>2?2:l%3]=f.getUint32(t.byteOffset,true);t.byteOffset+=4}else{U[l>1?2:l%3]=p++}}else{U[l>1?2:l%3]=p++}if(l>1){if(l%2===1){U.reverse()}Array.prototype.push.apply(b,U);d+=3;if(l%2===1){U.reverse()}U[0]=U[1];U[1]=U[2]}if(!a.j||a.j&&D){v.push(f.getFloat32(t.byteOffset,true));v.push(f.getFloat32(t.byteOffset+4,true));v.push(f.getFloat32(t.byteOffset+8,true));t.byteOffset+=12;y.push(f.getFloat32(t.byteOffset,true));y.push(f.getFloat32(t.byteOffset+4,true));y.push(f.getFloat32(t.byteOffset+8,true));t.byteOffset+=12;if(a.hasVertexColors){B=f.getUint32(t.byteOffset,true)>>8;t.byteOffset+=4;F.push(((B&16711680)>>16)*e);F.push(((B&65280)>>8)*e);F.push((B&255)*e)}else if(a.hasTextureUVs){O.push(f.getFloat32(t.byteOffset,true));O.push(f.getFloat32(t.byteOffset+4,true));t.byteOffset+=8}}}}if(I){I.count=d}c.push(d)}a.maxIdx=p;return a}function f(t){var r=t.g,f=t.h.buffers[t.h.buffers.length-1];var a=0,u=f.i,n=0,s=0,o=0,i=0,l=0,g=0,p=0,v=null,y=null,b=null,h=0,d=null,c=null,x=0,O=null,B=0,F=[0,0,0];f.vertexBuffer=[];f.indexBuffer=[];f.groupStartBuffer=[];f.groupCountBuffer=[];f.materialIndexBuffer=[];v=f.vertexBuffer;normalBuffer=f.normalBuffer;y=f.indexBuffer;b=f.groupStartBuffer;d=f.groupCountBuffer;c=f.materialIndexBuffer;if(f.hasVertexColors){f.vertexColorBuffer=[];O=f.vertexColorBuffer}for(a=0;a<u;++a){g=r.getInt32(t.byteOffset,true);t.byteOffset+=4;c.push(g);s=r.getUint32(t.byteOffset,true);t.byteOffset+=4;b.push(y.length);h=0;for(n=0;n<s;++n){l=p+(n>0||a>0?1:0);o=r.getUint16(t.byteOffset,true);t.byteOffset+=2;for(i=0;i<o;++i){if(i>1){y.push(y[y.length-1]);h++}var m=0;if(f.j){var U=i%8;if(U===0){B=r.getUint8(t.byteOffset,true);t.byteOffset+=1}m=(B&1<<U)===0;if(!m){y.push(r.getUint32(t.byteOffset,true));t.byteOffset+=4}else{y.push(p++)}}else{y.push(p++)}h++;if(!f.j||f.j&&m){v.push(r.getFloat32(t.byteOffset,true));v.push(r.getFloat32(t.byteOffset+4,true));v.push(r.getFloat32(t.byteOffset+8,true));t.byteOffset+=12;if(f.hasVertexColors){x=r.getUint32(t.byteOffset,true)>>8;t.byteOffset+=4;O.push(((x&16711680)>>16)*e);O.push(((x&65280)>>8)*e);O.push((x&255)*e)}}}}d.push(h)}f.maxIdx=p}function a(e,t){var r=e.byteOffset;var f=e.g;var a=f.getUint16(r,true);r+=2;if(a>0){var u=t.xtBodies;for(var n=0;n<a;n++){var s=f.getInt32(r,true);var o=u[s];r+=4;var i=f.getUint16(r,true);r+=2;if(i>0){var l={};var g={};var p=0;var v=0;for(var y=0;y<i;y++){var b=f.getInt32(r,true);r+=4;var h=f.getInt32(r,true);r+=4;var d=f.getInt32(r,true);r+=4;if(h<0||d<0){l[b]=Math.max(h,d);v++}else if(h>0&&d>0){g[b]={f1:h,f2:d};p++}}if(o){if(v>0){o.nonManifoldEdgeMap=l;o.nonManifoldEdgeMapSize=v}if(p>0){o.manifoldEdgeMap=g;o.manifoldEdgeMapSize=p}}}}}e.byteOffset=r}function u(e){var t=null;var a=e.g,u=e.h;u.buffers=[];var n=u.buffers,s=null,o=0,i=u.numBuffers,l=0;for(o=0;o<i;++o){n.push({});s=n[o];l=a.getUint8(e.byteOffset,true);e.byteOffset+=1;s.geometryType=l&3;l=l&252;s.j=(l&4)>0;s.hasTextureUVs=(l&8)>0;s.hasVertexColors=(l&16)>0;s.i=a.getUint16(e.byteOffset,true);e.byteOffset+=2;switch(s.geometryType){case 0:r(e,false);break;case 1:f(e);break;case 2:t=r(e,true);break;case 3:break;default:throw{name:"BOD processing error",message:"Invalid thisBuffer type: "+s.geometryType.toString()}}delete s.j}return t}function n(e){var t=e.h.materials,r=null,f=null,a=null,u=e.h.buffers,n=null,s=0,o=0;var i=e.ports;i.push(e.g.buffer);if(t){if(t.phong){t.phong.index=new Uint32Array(t.phong.index);i.push(t.phong.index.buffer);t.phong.diffuse=new Uint32Array(t.phong.diffuse);i.push(t.phong.diffuse.buffer);t.phong.emissive=new Uint32Array(t.phong.emissive);i.push(t.phong.emissive.buffer);t.phong.specular=new Uint32Array(t.phong.specular);i.push(t.phong.specular.buffer);t.phong.shininess=new Float32Array(t.phong.shininess);i.push(t.phong.shininess.buffer)}if(t.flat){t.flat.index=new Uint32Array(t.flat.index);i.push(t.flat.index.buffer);t.flat.diffuse=new Uint32Array(t.flat.diffuse);i.push(t.flat.diffuse.buffer)}if(t.texture){t.texture.index=new Uint32Array(t.texture.index);i.push(t.texture.index.buffer);for(var l=0,g=t.texture.index.length;l<g;++l){t.texture.texB64Data[l]=new Uint8Array(t.texture.texB64Data[l]);i.push(t.texture.texB64Data[l].buffer)}}}for(s=0,o=e.h.numBuffers;s<o;++s){n=u[s];n.vertexBuffer=new Float32Array(n.vertexBuffer);i.push(n.vertexBuffer.buffer);if(n.maxIdx<65536){n.indexBuffer=new Uint16Array(n.indexBuffer)}else{n.indexBuffer=new Uint32Array(n.indexBuffer)}i.push(n.indexBuffer.buffer);n.groupStartBuffer=new Uint32Array(n.groupStartBuffer);i.push(n.groupStartBuffer.buffer);n.groupCountBuffer=new Uint32Array(n.groupCountBuffer);i.push(n.groupCountBuffer.buffer);if(n.normalBuffer){n.normalBuffer=new Float32Array(n.normalBuffer);i.push(n.normalBuffer.buffer)}if(n.vertexColorBuffer){n.vertexColorBuffer=new Float32Array(n.vertexColorBuffer);i.push(n.vertexColorBuffer.buffer)}else if(n.materialIndexBuffer){n.materialIndexBuffer=new Int32Array(n.materialIndexBuffer);i.push(n.materialIndexBuffer.buffer)}if(n.uvCoordinatesBuffer){n.uvCoordinatesBuffer=new Float32Array(n.uvCoordinatesBuffer);i.push(n.uvCoordinatesBuffer.buffer)}}delete e.byteOffset}function s(e){var r=e.g,f=e.h;f.numMaterials=r.getUint32(e.byteOffset,true);e.byteOffset+=4;f.numBuffers=r.getUint32(e.byteOffset,true);e.byteOffset+=4;if(f.numMaterials>0){t(e)}var s=null;if(f.numBuffers>0){s=u(e)}if(s){a(e,s)}n(e)}function o(e){var t=e.g;e.byteOffset+=6;var r=t.getUint16(e.byteOffset,true);e.byteOffset+=2;var f=null;if(r>=8){f=t.getUint32(e.byteOffset,true);e.byteOffset+=4}var a=t.getUint32(e.byteOffset,true);e.byteOffset+=4;e.byteOffset+=a;switch(r){case 8:s(e);break;default:throw{name:"BOD processing error",message:"Unsupported BOD version: "+r.toString()+(f!==null?"."+f:"")}}}var i=function(){};i.prototype.k=o;PLMVisWeb.l=i})();(function(){function e(e,t){var r=new Uint16Array(e),f="";for(var a=0,u=r.length;a<u;a+=65535){if(a+65535>u){f+=String.fromCharCode.apply(null,r.subarray(a,a+(u-a)))}else{f+=String.fromCharCode.apply(null,r.subarray(a,a+65535))}}return f}function t(e,t){if(e.m!==undefined){var r=atob(e.m),f=[];for(var a=0,u=r.length;a<u;++a){f.push(r.charCodeAt(a))}r=null;e.o=new Uint8Array(f).buffer}else{e.o=undefined}}var r=new PLMVisWeb.l;var f=function(f,a){var u=null,n=null;var s={g:null,h:{},ports:[],byteOffset:0,url:f.url||"base64"};if(f.binaryData){try{s.g=new DataView(f.binaryData);r.k(s);a(s.h,s.ports)}catch(e){console.error("%s - %s",e.name,e.message);a()}}else if(f.url){var o=new XMLHttpRequest;var i=f.url;o.open("GET",i);o.responseType="arraybuffer";o.onload=function(){if(o.response!==undefined&&(o.status===200||o.status===0)){if(o.response!=null){if(o.response.byteLength>0){s.g=new DataView(o.response);o.response=null;r.k(s);a(s.h,s.ports)}else{a(null,null)}}else{console.warn("Failed to receive XMLHttpRequest data!",i);a()}}else{console.warn("Failed to receive XMLHttpRequest response!",i);a()}};o.onerror=function(){console.error("BodWorker failed to retrieve:"+f.url);a()};o.send(null)}else if(f.base64Data){try{var l={m:e(f.base64Data,f.url)};delete f.base64Data;s.g=new DataView(t(l,f.url));r.k(s);a(s.h,s.ports)}catch(e){console.error("%s - %s",e.name,e.message);a()}}};PLMVisWeb.BodWorker={processMessage:f}})();(function(){var e=0;var t=1;var r=2;var f=3;var a=4;var u=5;var n=6;var s=11;var o=13;var i=15;var l=function(e,t,r){var f={};f.x=e.getFloat32(t,true);t+=4;f.y=e.getFloat32(t,true);t+=4;f.z=e.getFloat32(t,true);t+=4;r.location=f;var a={};a.x=e.getFloat32(t,true);t+=4;a.y=e.getFloat32(t,true);t+=4;a.z=e.getFloat32(t,true);t+=4;r.axis=a;r.radius=e.getFloat32(t,true);t+=4;return t};var g=function(e,t,r){var f={};f.x=e.getFloat32(t,true);t+=4;f.y=e.getFloat32(t,true);t+=4;f.z=e.getFloat32(t,true);t+=4;r.location=f;var a={};a.x=e.getFloat32(t,true);t+=4;a.y=e.getFloat32(t,true);t+=4;a.z=e.getFloat32(t,true);t+=4;r.axis=a;r.majorRadius=e.getFloat32(t,true);t+=4;r.minorRadius=e.getFloat32(t,true);t+=4;return t};var p=function(e,t,r){return t};var v=function(e,t,r){var f={};f.x=e.getFloat32(t,true);t+=4;f.y=e.getFloat32(t,true);t+=4;f.z=e.getFloat32(t,true);t+=4;r.location=f;var a={};a.x=e.getFloat32(t,true);t+=4;a.y=e.getFloat32(t,true);t+=4;a.z=e.getFloat32(t,true);t+=4;r.axis=a;return t};var y=function(e,t,r){var f={};f.x=e.getFloat32(t,true);t+=4;f.y=e.getFloat32(t,true);t+=4;f.z=e.getFloat32(t,true);t+=4;r.location=f;var a={};a.x=e.getFloat32(t,true);t+=4;a.y=e.getFloat32(t,true);t+=4;a.z=e.getFloat32(t,true);t+=4;r.axis=a;r.radius=e.getFloat32(t,true);t+=4;return t};var b=function(e,t,r){var f={};f.x=e.getFloat32(t,true);t+=4;f.y=e.getFloat32(t,true);t+=4;f.z=e.getFloat32(t,true);t+=4;r.origin=f;r.radius=e.getFloat32(t,true);t+=4;return t};var h=function(e,t,r){var f={};f.x=e.getFloat32(t,true);t+=4;f.y=e.getFloat32(t,true);t+=4;f.z=e.getFloat32(t,true);t+=4;r.location=f;var a={};a.x=e.getFloat32(t,true);t+=4;a.y=e.getFloat32(t,true);t+=4;a.z=e.getFloat32(t,true);t+=4;r.axis=a;r.radius=e.getFloat32(t,true);r.radius=15;t+=4;var u=e.getFloat32(t,true);r.cosHalfAngle=Math.cos(u);r.oneDivideCosHalfAngle=1/r.cosHalfAngle;t+=4;var n=r.radius/Math.tan(r.p);var s={x:f.x+n*a.x,y:f.y+n*a.y,z:f.z+n*a.z};r.apex=s;return t};var d=function(e,t,r){var f={};f.x=e.getFloat32(t,true);t+=4;f.y=e.getFloat32(t,true);t+=4;f.z=e.getFloat32(t,true);t+=4;r.location=f;var a={};a.x=e.getFloat32(t,true);t+=4;a.y=e.getFloat32(t,true);t+=4;a.z=e.getFloat32(t,true);t+=4;r.axis=a;r.majorRadius=e.getFloat32(t,true);t+=4;r.minorRadius=e.getFloat32(t,true);t+=4;return t};var c=function(x,O,B,F,m){var U=x.getUint8(O,true);B.entityType=U;O+=1;switch(U){case n:B.offset=x.getFloat32(O,true);B.underlyingSurface={};O=c(x,O,B.underlyingSurface,F,m);break;case t:O=v(x,O,B);break;case r:O=y(x,O,B);break;case f:O=b(x,O,B);break;case a:O=h(x,O,B);break;case u:O=d(x,O,B);break;case s:O=l(x,O,B);break;case o:O=g(x,O,B);break;case i:O=p(x,O,B);break;case e:var w=x.getInt32(O,true);O+=4;var C=x.getInt32(O,true);O+=4;var I=F[C];if(I){F[m]=I}break;default:console.warn("PLMVisWeb.XTBodWorker: Unknown geometry type is encountered");break}return O};var x=function(e,t,r,f){var a=-1;var u=0;for(var n=0;n<f;n++){var s=u;r[u++]=e.getFloat32(t,true);t+=4;r[u++]=e.getFloat32(t,true);t+=4;r[u++]=e.getFloat32(t,true);t+=4;if(n>0&&n<f-1){r[u++]=r[s++];r[u++]=r[s++];r[u++]=r[s++]}}return t};var O=function(e){var t=e.g,r=0,f=0;var a=String.fromCharCode(t.getUint8(r+0,true))+String.fromCharCode(t.getUint8(r+1,true))+String.fromCharCode(t.getUint8(r+2,true))+String.fromCharCode(t.getUint8(r+3,true))+String.fromCharCode(t.getUint8(r+4,true))+String.fromCharCode(t.getUint8(r+5,true));r+=6;var u=t.getUint16(r,true);r+=2;var n=t.getUint32(r,true);r+=4;r+=t.getUint32(r,true)+4;var s=t.getUint32(r,true);r+=4;if(!e.parseXTFacetData){var o=t.getUint32(r,true);r+=4;var i={};for(var l=0;l<o;l++){var g=t.getUint32(r,true);r+=4;var p=t.getUint32(r,true);r+=4;if(p<=0){continue}xtEntityMap={};i[g]=xtEntityMap;for(var v=0;v<p;v++){var y={};var b=t.getUint32(r,true);r+=4;xtEntityMap[b]=y;r=c(t,r,y,xtEntityMap,b)}}e.h.xtDescriptions=i;return}r+=s;var h=t.getUint32(r,true);r+=4;var d={};for(var l=0;l<h;l++){var g=t.getUint32(r,true);r+=4;var p=t.getUint32(r,true);r+=4;if(p<=0){continue}var O={};d[g]=O;for(var v=0;v<p;v++){var B=t.getInt32(r,true);r+=4;var F=t.getUint16(r,true);r+=2;var m=(F-2)*2+2;var U=new Float32Array(m*3);O[B]=U;r=x(t,r,U,F)}}if(e.xtIds&&e.xtIds.length>0){var O=d[e.psId];if(O){var w={};for(var l=0,C=e.xtIds.length;l<C;l++){var B=e.xtIds[l];var I=O[B];if(I){w[B]={positions:I};e.ports.push(I.buffer)}}e.h.nonManifoldEdges=w}}};var B=function(e,t){var r=new PLMVisWeb.l,f=null,a=null;var u={g:null,psId:e.psId,xtIds:e.xtIds,parseXTFacetData:e.parseXTFacetData,h:{callbackId:e.callbackId},ports:[],byteOffset:0,url:e.url||"base64"};if(e.binaryData){try{u.g=new DataView(e.binaryData);O(u);t(u.h,u.ports)}catch(e){console.error("%s - %s",e.name,e.message);t()}}else if(e.url){var n=new XMLHttpRequest;var s=e.url;n.open("GET",s);n.responseType="arraybuffer";n.onload=function(){if(n.response!==undefined&&(n.status===200||n.status===0)){if(n.response!=null){if(n.response.byteLength>0){u.g=new DataView(n.response);n.response=null;O(u);t(u.h,u.ports)}else{t(null,null)}}else{console.warn("Failed to receive XMLHttpRequest data!",s);t()}}else{console.warn("Failed to receive XMLHttpRequest response!",s);t()}};n.onerror=function(){console.error("Failed to retrieve "+s);t()};n.send(null)}else if(e.base64Data){try{var o={m:_ab2str(e.base64Data,e.url)};delete e.base64Data;u.g=new DataView(_decodeBase64ToBinaryBuffer(o,e.url));O(u);t(u.h,u.ports)}catch(e){console.error("%s - %s",e.name,e.message);t()}}};PLMVisWeb.XTBodWorker={processMessage:B}})();
